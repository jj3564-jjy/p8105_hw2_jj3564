---
title: "p8105_hw2_jj3564"
output: github_document
date: "2025-10-01"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)

library(tidyverse)
library(readxl)
library(knitr)

```

# Problem 0

This homework uses GitHub, R Projects, and R Markdown for reproducibility. All data files are stored in the `data/` sub directory, and relative paths are used.

# Problem 1

## data cleaning first 

```{r}
## load data
pols_df = read_csv("data/fivethirtyeight_datasets/pols-month.csv")

## clean data
pols_cleaned = pols_df |> 
  separate('mon', into = c("year", "month", "day"), sep = "-", convert = TRUE) |> 
  mutate(
      month = month.name[month],
      president = case_when(
      prez_dem == 1 ~ "dem",
      prez_gop == 1 ~ "gop",
      TRUE ~ NA_character_
    )
  ) |> 
  select(-prez_gop,-prez_dem, -day) |> 
  select (year, month, president, everything())
  
pols_cleaned
```

The pols-month.csv dataset contained monthly political control data, including presidential party affiliation (prez_gop/prez_dem) and the distribution of governorships and congressional seats, starting from 1947. 

## Clean snp.csv data

```{r}
## load data
snp_df = read_csv("data/fivethirtyeight_datasets/snp.csv")

## clean data
snp_cleaned = snp_df |> 
  separate(date, into = c("month_num", "day", "year_short"), sep = "/", convert = TRUE)  |> 

  mutate(
    year = case_when(
      year_short <= 49 ~ year_short + 2000,
      year_short >= 50 ~ year_short + 1900,
    ),
    month = month.name[month_num]
  )  |>  
  select(year, month, snp_value = close) |> 
    # arrange by year and month
  arrange(year, month)

snp_cleaned
```



### Clean `unemployment.csv`
This dataset is in wide format, with months as columns. We pivot it into long format and ensure the month variable matches the same names as before

```{r}
## load data
unemployment_df = read_csv("data/fivethirtyeight_datasets/unemployment.csv")

## tidy data
unemployment_cleaned = unemployment_df |> 
  rename(year = Year) |> 
  pivot_longer(
    cols = Jan:Dec,
    names_to = "month",
    values_to = "unemployment"
  ) |> 
mutate(
    month = month.name[match(month, month.abb)]
) |> 
select(year, month, unemployment) |> 
arrange(year, month)

unemployment_cleaned
```



### Merge datasets
We merge `pols` with `snp`, then merge unemployment.

```{r}
mergesum_df = pols_cleaned |> 
  left_join(snp_cleaned, by = c("year", "month")) |> 
  left_join(unemployment_cleaned, by = c("year", "month"))

mergesum_df
final_dim = dim(mergesum_df)
final_years = range(mergesum_df$year)
final_names = names(mergesum_df)

mergesum_df
```

**Summary**: The `pols` dataset contains information about political party control. The `snp` dataset contains S&P stock market closing values. The `unemp` dataset contains unemployment percentages. After merging, we have `r mergesum_df$n_obs` observations, spanning `r mergesum_df$min_year` to `r mergesum_df$max_year`. Key variables: `year`, `month`, `president`, `close` (S&P index), and `unemployment`.


# Problem 2: Trash Wheel Data



### Clean Mr. Trash Wheel
```{r trash}

mr_trash <- read_excel("data/202509 Trash Wheel Collection Data.xlsx",  sheet = "Mr. Trash Wheel",
  range = cell_cols("A:N")) %>%
janitor::clean_names() %>%
filter(!is.na(dumpster)) %>%
mutate(
    sports_balls = as.integer(round(sports_balls, 0)),
    year = as.numeric(year),    
    wheel = "Mr. Trash Wheel")
```


### Clean Professor Trash Wheel
```{r}
prof_trash <- read_excel("data/202509 Trash Wheel Collection Data.xlsx", sheet = "Professor Trash Wheel", skip = 1) %>%
janitor::clean_names() %>%
filter(!is.na(dumpster)) %>%
mutate(
    year = as.numeric(year),   
    wheel = "Professor Trash Wheel"
  )

 


```


### Clean Gwynnda
```{r Gwynnda}
  gwynnda_df <- read_excel(
  "data/202509 Trash Wheel Collection Data.xlsx",
  sheet = "Gwynns Falls Trash Wheel"
) |> 
  janitor::clean_names() |> 
  filter(!is.na(dumpster)) |> 
  mutate(
    year = as.numeric(year),     
    wheel = "Gwynns Falls Trash Wheel"
  )
trash_all <- bind_rows(mr_trash, prof_trash, gwynnda_df)
```
### Summary statistics
```{r trash-summary}
n_obs <- nrow(trash_all)
total_prof_weight <- sum(filter(trash_all, wheel == "Professor")$weight_tons, na.rm = TRUE)
gwynnda_cigs_jun22 <- trash_all %>% filter(wheel == "Gwynnda", month == 6, year == 2022) %>%
summarize(total = sum(cigarette_butts, na.rm = TRUE)) %>% pull(total)


n_obs; total_prof_weight; gwynnda_cigs_jun22
```


**Summary**: The combined dataset has `r n_obs` observations. Key variables include dumpster ID, collection date, trash weight, and item counts. Professor Trash Wheel collected `r round(total_prof_weight,1)` tons of trash in total. Gwynnda collected `r gwynnda_cigs_jun22` cigarette butts in June 2022.




# Problem 3: Zillow Rent Data

## Wrangling the datasets
We start by importing both the Zillow Observed Rent Index (ZORI) data and the ZIP code reference file. Then we reshape ZORI into tidy format and create useful date variables.

```{r}
# File paths
zori_path <- "data/zillow_data/Zip_zori_uc_sfrcondomfr_sm_month_NYC.csv"
zip_path  <- "data/zillow_data/Zip Codes.csv"

# Tidy ZORI dataset
zori_data <- read_csv(zori_path) |> 
  pivot_longer(
    cols = matches("^20"),   # select columns that look like years
    names_to = "date",
    values_to = "rent_index"
  ) |> 
  mutate(
    date = ymd(date),
    year = year(date),
    month_num = month(date)
  )

# Clean ZIP code dataset
zip_data <- read_csv(zip_path) |> 
   janitor::clean_names() 
```

## Merge the datasets
Next, we join the rent index data with neighborhood-level ZIP information.

```{r}
zillow_data <- zori_data |> 
  left_join(zip_data, by = c("RegionName" = "zip_code")) |> 
  arrange(RegionName, date)
```

## Dataset description
We summarize the size of the final dataset and highlight how many unique ZIP codes and neighborhoods are included.

```{r}
n_total <- nrow(zillow_data)

n_zipcodes <- n_distinct(zillow_data$RegionName)

n_hoods <- n_distinct(zillow_data$neighborhood)

list(
  total_observations = n_total,
  distinct_zipcodes = n_zipcodes,
  distinct_neighborhoods = n_hoods
)
names(zillow_data)
str(zillow_data$month_num)
str(zillow_data$year)
str(zillow_data$date)
```

The tidy dataset is structured as follows:

- The dataset contains **`r n_total` total observations**.  
- There are **`r n_zipcodes` unique ZIP codes** represented.  
- These ZIP codes span **`r n_hoods` different neighborhoods** across NYC.

## ZIP codes not present in ZORI
We identify which ZIP codes are in the geographic reference file but missing in the Zillow rent dataset.

```{r}
missing_zipcodes <- setdiff(zip_data$zip_code, unique(zori_data$RegionName))
```

There are `r length(missing_zipcodes)` ZIP codes absent from the Zillow rent index. The first five are shown below:

```{r}
zip_data |>
  filter(zip_code %in% missing_zipcodes) |>
  select(zip_code, county, neighborhood) |>
  head(5) |>
  knitr::kable(caption = "First 5 ZIP Codes Missing from ZORI")
```

Possible explanations include:

1. **Low listing counts**: ZIP codes with very few rental listings might not meet Zillowâ€™s threshold for index calculation.
2. **Specialized land use**: ZIP codes dominated by parks, campuses, or commercial zones may lack sufficient market housing.
3. **Incomplete data**: Some areas might not have reliable or consistent data over time.

## Rental price changes during COVID
We now compare rent levels between January 2020 and January 2021.

```{r rental price changes}
price_changes_tmp <- zillow_data |> 
  filter(date %in% c("2020-01-31", "2021-01-31")) |> 
 
 select(-year) |> 
  pivot_wider(
    names_from = date, 
    values_from = rent_index,
    names_prefix = "price_"
  ) |> 


  mutate(price_change = `price_2021-01-31` - `price_2020-01-31`) |> 
  arrange(desc(price_change)) |> 
  slice(1:10)
  
  
```

The table below shows the 10 ZIP codes with the sharpest declines.

```{r}
price_changes_tmp |>
  select(
    `ZIP Code` = RegionName,
    Borough = county, 
    Neighborhood = neighborhood,
    `Rent Jan 2020` = `price_2020-01-31`,
    `Rent Jan 2021` = `price_2021-01-31`,
    `Drop in Rent ($)` =
  ) |>
  knitr::kable(
    digits = 2,
    caption = "Top 10 NYC ZIP Codes with Largest Rent Drop (Jan 2020 vs Jan 2021)"
  )
```

**Interpretation**: The biggest rental declines occurred in Manhattan, particularly in business-heavy areas such as Downtown and Midtown. These trends reflect the pandemic-driven outmigration and drop in demand for high-cost rentals in dense neighborhoods that rely on in-office work.


